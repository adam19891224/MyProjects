/**
 * 类别标签特效
 * 感谢 次碳酸钴 -- https://www.web-tinker.com
 * @constructor
 */
function CategoryUtils(){var pi=Math.PI,sin=Math.sin,cos=Math.cos,tan=Math.tan,acos=Math.acos,abs=Math.abs;var $window=$(window);var _this=this;var randomColor=function(){var colorStr=Math.floor(Math.random()*16777215).toString(16).toUpperCase();function colorHexToRGB(color){color=color.toUpperCase();var regexpHex=/^#[0-9a-fA-F]{3,6}$/;if(regexpHex.test(color)){var hexArray=[];var count=1;for(var i=1;i<=3;i++){if(color.length-2*i>3-i){hexArray.push(Number("0x"+color.substring(count,count+2)));count+=2}else{hexArray.push(Number("0x"+color.charAt(count)+color.charAt(count)));count+=1}}return hexArray.join(",")}else{return color}}return colorHexToRGB("#"+"000000".substring(0,6-colorStr)+colorStr)};this.init=function($element){var items=$element.find("a");if(items.length<=0){return false}if($element.is(":hidden")){return $window.one("resize",$.proxy(_this.init,null,$element))}var oWidth=$element.width();var oHeight=$element.height();var offset=$element.offset();$window.resize(function(){offset=$element.offset()});var scale=window.devicePixelRatio|0||1;var width=oWidth*scale;var height=oHeight*scale;var drawEvn,canvas;canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;canvas.style.width=oWidth+"px";canvas.style.height=oHeight+"px";$element.append(canvas);drawEvn=canvas.getContext("2d");drawEvn.translate(width/2+0.5,height/2+0.5);drawEvn.textBaseline="middle";drawEvn.textAlign="center";new Promise(function(resolve){var c=8;var count=items.length;var index=0;var n,m,w,h;function addGraphics(){var item;items.each(function(){item=$(this);n=2*(index+1)/(count+2)-1;m=sin(acos(n));item.data("graphic",{x:sin(c*pi*n)*m,y:n,z:cos(c*pi*n)*m,width:w=item.outerWidth()*scale,height:h=item.outerHeight()*scale,text:item.text(),font:item.css("font-size").replace(/\d+/,function($0){return $0*scale})+" "+item.css("font-family")+" ",color:randomColor(),href:item.attr("href")});drawEvn?item.hide():item.show().css({visibility:"visible",marginLeft:-w/2,marginTop:-h/2,opacity:0,borderBottomColor:item.css("color")});index++})}addGraphics();resolve()}).then(function(){var A=1/tan(37*pi/360),Z=6.4;var iterator=0;var nextFrame=function(){if(--iterator<-628){iterator=0}draw()};var draw=function(){var o,x,y,z,s,c;s=sin(iterator/100);c=cos(iterator/100);if(drawEvn){drawEvn.clearRect(-width/2,-height/2,width,height)}var itemData;items.each(function(){itemData=$(this).data("graphic");x=itemData.x*c+itemData.z*s;z=itemData.z*c-itemData.x*s;y=itemData.y;z+=1+Z;itemData.px=height*A*x/z|0;itemData.py=height*A*y/z|0;itemData.pz=1-(z-Z)*0.35;if(drawEvn){drawEvn.fillStyle="rgba("+itemData.color+","+itemData.pz+")";drawEvn.font=itemData.font;drawEvn.fillText(itemData.text,itemData.px,itemData.py)}else{o.style.left=itemData.px+width/2+"px";o.style.top=itemData.py+height/2+"px";o.style.zIndex=o.filters[0].opacity=itemData.pz*100|0}})};var proxy={nextFrame:nextFrame,draw:draw};return Promise.resolve(proxy)}).then(function(proxy){var handle=0;function play(){proxy.nextFrame();handle=requestAnimationFrame(play)}$element.hover(function(){cancelAnimationFrame(handle);handle=0},function(){if(handle==0){play()}}).mouseleave();return Promise.resolve(proxy)}).then(function(proxy){if(!canvas){return}var active;$(canvas).on({click:function(){if(active){window.open(active.attr("href"))}},mousemove:function(e){var x=(e.pageX-offset.left-oWidth/2)*scale;var y=(e.pageY-offset.top-oHeight/2)*scale;var item,itemData;active=null;items.each(function(){item=$(this);itemData=item.data("graphic");if(abs(itemData.px-x)*2<itemData.width&&abs(itemData.py-y)*2<itemData.height&&(active?itemData.z<active.z:1)){active=item}});proxy.draw();$(canvas).css("cursor",active?"pointer":"");if(!active){return}var nowData=active.data("graphic");drawEvn.fillStyle="rgba("+nowData.color+","+nowData.pz+")";drawEvn.fillRect(nowData.px-active.width()/2,nowData.py+active.height()/2,active.width(),2)}})})["catch"](function(e){console.log(e)})}};